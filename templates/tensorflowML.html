{% extends "base.html" %}
{% block head %}
<link href="/static/tensorflow.css" rel="stylesheet"/>

{% endblock %}
{% block content %}
<h1>Classifieur ML</h1>

<div class="slider-container">
    <label for="batchsize">Batch size</label>
    <input type="range" id="batchsize" min="32" max="256" value="128" step="32"
           oninput="updateDisplay('batchsize')">
    <div id="batchsize-display">128</div>
</div>

<div class="slider-container">
    <label for="epochs">Epochs</label>
    <input type="range" id="epochs" min="1" max="20" value="5" step="1"
           oninput="updateDisplay('epochs')">
    <div id="epochs-display">5</div>
</div>

<button id="train-btn" onclick="trainModel()">Entraîner</button>
<div id="status"></div>
<div id="results"></div>

<!-- Section pour l'étude de sensibilité -->
<button id="sensitivity-btn" class="sensitivity-button" onclick="runSensitivityStudy()" style="display:none;">
    Lancer l'étude de sensibilité
</button>
<h2 id="sensitivityTitle" style="display:none;">Étude de sensibilité :</h2>
<div id="sensitivityResult" style="display:none;"></div>

<script>
function updateDisplay(id) {
    document.getElementById(id + "-display").textContent =
        document.getElementById(id).value;
}

async function trainModel() {
    const batchsize = document.getElementById("batchsize").value;
    const epochs = document.getElementById("epochs").value;
    const btn = document.getElementById("train-btn");
    const status = document.getElementById("status");
    
    // Cacher l'étude de sensibilité précédente
    document.getElementById('sensitivityResult').style.display = 'none';
    document.getElementById('sensitivityTitle').style.display = 'none';
    document.getElementById('sensitivity-btn').style.display = 'none';

    // Désactiver le bouton + afficher message
    btn.disabled = true;
    btn.textContent = "⏳ Entraînement...";
    status.textContent = "Modèle en cours d'entraînement, merci de patienter...";

    try {
        const response = await fetch("/tensorflow_train", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ batchsize, epochs })
        });

        const data = await response.json();

        document.getElementById("results").innerHTML = `
            <h3>Résultats :</h3>
            <p><b>Loss</b> : ${data.loss.toFixed(4)}</p>
            <p><b>Accuracy</b> : ${(data.accuracy*100).toFixed(2)}%</p>
        `;
        
        // Afficher le bouton d'étude de sensibilité après un entraînement réussi
        document.getElementById('sensitivity-btn').style.display = 'block';
        
    } catch (error) {
        status.textContent = "❌ Erreur pendant l'entraînement";
    } finally {
        // Réactiver le bouton après la fin
        btn.disabled = false;
        btn.textContent = "Entraîner";
        status.textContent = "";
    }
}

async function runSensitivityStudy() {
    const sensitivityBtn = document.getElementById("sensitivity-btn");
    const status = document.getElementById("status");
    
    // Désactiver le bouton et afficher le status
    sensitivityBtn.disabled = true;
    sensitivityBtn.textContent = "⏳ Étude en cours...";
    status.textContent = "Étude de sensibilité en cours, cela peut prendre plusieurs minutes...";
    
    try {
        const response = await fetch("/tensorflow_sensitivity");
        const data = await response.json();
        
        if (data.error) {
            document.getElementById('sensitivityResult').innerHTML = 
                `<p style='color:red;'>${data.error}</p>`;
        } else {
            // Construire le tableau HTML
            let html = `<h4>Tableau d'étude de sensibilité (Batch Size vs Epochs)</h4>`;
            html += "<table><tr><th>batch_size \\ epochs</th>";

            // Colonnes (epochs)
            const columns = Object.keys(data[Object.keys(data)[0]]);
            columns.sort((a, b) => parseInt(a) - parseInt(b)); // Trier numériquement
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += "</tr>";

            // Lignes (batch_size)
            const rows = Object.keys(data).sort((a, b) => parseInt(a) - parseInt(b));
            rows.forEach(row => {
                html += `<tr><td>${row}</td>`;
                columns.forEach(col => {
                    let value = data[row][col];
                    html += `<td>${value.toFixed(4)}</td>`;
                });
                html += "</tr>";
            });

            html += "</table>";
            document.getElementById('sensitivityResult').innerHTML = html;

            // Afficher le titre et les résultats
            document.getElementById('sensitivityTitle').style.display = 'block';
            document.getElementById('sensitivityResult').style.display = 'block';

            // Mettre en évidence la case avec la meilleure accuracy
            const tableRows = document.querySelectorAll("#sensitivityResult table tr");
            let maxVal = -Infinity;
            let maxCell = null;

            tableRows.forEach((row, i) => {
                if (i === 0) return; // skip header

                const cells = row.querySelectorAll("td");
                cells.forEach((cell, j) => {
                    if (j === 0) return; // skip batch_size column
                    const val = parseFloat(cell.textContent);
                    if (!isNaN(val) && val > maxVal) {
                        maxVal = val;
                        maxCell = cell;
                    }
                });
            });

            if (maxCell) {
                maxCell.classList.add("max-cell");
            }
        }
    } catch (error) {
        document.getElementById('sensitivityResult').innerHTML = 
            "<p style='color:red;'>Erreur serveur lors de l'étude de sensibilité</p>";
        console.error(error);
    } finally {
        // Réactiver le bouton
        sensitivityBtn.disabled = false;
        sensitivityBtn.textContent = "Lancer l'étude de sensibilité";
        status.textContent = "";
    }
}
</script>
{% endblock %}